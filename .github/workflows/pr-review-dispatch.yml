name: PR Review Agent Dispatch

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  dispatch-to-agent:
    # Only run for PR comments (not issue comments)
    if: |
      github.event_name == 'pull_request_review' ||
      github.event_name == 'pull_request_review_comment' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)

    runs-on: ubuntu-latest

    steps:
      - name: Extract PR Information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, commentBody, commentAuthor, reviewState;

            if (context.eventName === 'pull_request_review') {
              prNumber = context.payload.pull_request.number;
              commentBody = context.payload.review.body || '';
              commentAuthor = context.payload.review.user.login;
              reviewState = context.payload.review.state;
            } else if (context.eventName === 'pull_request_review_comment') {
              prNumber = context.payload.pull_request.number;
              commentBody = context.payload.comment.body;
              commentAuthor = context.payload.comment.user.login;
              reviewState = 'comment';
            } else {
              // issue_comment on a PR
              prNumber = context.payload.issue.number;
              commentBody = context.payload.comment.body;
              commentAuthor = context.payload.comment.user.login;
              reviewState = 'comment';
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('comment_body', commentBody);
            core.setOutput('comment_author', commentAuthor);
            core.setOutput('review_state', reviewState);

            console.log(`PR #${prNumber} received ${reviewState} from ${commentAuthor}`);
            console.log(`Comment: ${commentBody.substring(0, 200)}...`);

      - name: Check for Agent Session
        id: check-session
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          # Check if there's a stored agent session for this PR
          # This would query your agent store (see webhook handler)
          echo "Checking for agent session for PR #$PR_NUMBER"
          echo "has_session=true" >> $GITHUB_OUTPUT

      - name: Dispatch to Webhook Handler
        if: steps.check-session.outputs.has_session == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.PR_REVIEW_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.PR_REVIEW_WEBHOOK_SECRET }}
        run: |
          # Skip if no webhook URL configured
          if [ -z "$WEBHOOK_URL" ]; then
            echo "WEBHOOK_URL not configured. Skipping dispatch."
            echo "To enable PR review agent, set PR_REVIEW_WEBHOOK_URL secret."
            exit 0
          fi

          # Create payload
          PAYLOAD=$(cat <<EOF
          {
            "event": "${{ github.event_name }}",
            "pr_number": ${{ steps.pr-info.outputs.pr_number }},
            "review_state": "${{ steps.pr-info.outputs.review_state }}",
            "comment_author": "${{ steps.pr-info.outputs.comment_author }}",
            "comment_body": $(echo '${{ steps.pr-info.outputs.comment_body }}' | jq -Rs .),
            "repository": "${{ github.repository }}",
            "sha": "${{ github.sha }}"
          }
          EOF
          )

          # Generate HMAC signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | cut -d' ' -f2)

          # Send to webhook handler (Vercel API route)
          curl -X POST "$WEBHOOK_URL/api/pr-review" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD" \
            --fail --silent --show-error

      - name: Log Dispatch Status
        run: |
          echo "PR Review dispatch completed for PR #${{ steps.pr-info.outputs.pr_number }}"
          echo "Review state: ${{ steps.pr-info.outputs.review_state }}"
          echo "Author: ${{ steps.pr-info.outputs.comment_author }}"
