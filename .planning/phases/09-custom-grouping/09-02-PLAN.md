---
phase: 09-custom-grouping
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/ui/components/settings/MuscleGroupEditor.tsx
  - src/ui/components/settings/SortableGroupRow.tsx
  - src/ui/components/settings/SortableMuscleItem.tsx
  - src/ui/components/settings/MusclePickerModal.tsx
  - src/ui/components/settings/ConfirmationDialog.tsx
  - src/ui/pages/Settings.tsx
autonomous: true
user_setup:
  - service: "@dnd-kit"
    why: "Drag-and-drop reordering for groups and muscles"
    install: "npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities"

must_haves:
  truths:
    - "User can see all muscle groups in Settings"
    - "User can add a new group (up to 8)"
    - "User can rename a group inline"
    - "User can delete a group (muscles move to ungrouped)"
    - "User can drag groups to reorder"
    - "User can expand a group to see its muscles"
    - "User can add muscles to a group via picker"
    - "User can remove muscles from a group"
    - "User can drag muscles to reorder within group"
    - "User can reset to default groupings"
    - "Changes auto-save immediately"
  artifacts:
    - path: "src/ui/components/settings/MuscleGroupEditor.tsx"
      provides: "Main accordion UI for editing groups"
      min_lines: 100
    - path: "src/ui/components/settings/SortableGroupRow.tsx"
      provides: "Single draggable group row with expand/edit"
      min_lines: 80
    - path: "src/ui/components/settings/SortableMuscleItem.tsx"
      provides: "Single draggable muscle item"
      min_lines: 40
    - path: "src/ui/components/settings/MusclePickerModal.tsx"
      provides: "Modal to select muscles to add"
      min_lines: 60
    - path: "src/ui/components/settings/ConfirmationDialog.tsx"
      provides: "Reusable confirmation dialog"
      min_lines: 30
    - path: "src/ui/pages/Settings.tsx"
      provides: "Settings page with Muscle Groups section"
      contains: "MuscleGroupEditor"
  key_links:
    - from: "src/ui/components/settings/MuscleGroupEditor.tsx"
      to: "src/db/hooks/useMuscleGroups.ts"
      via: "useEffectiveMuscleGroupConfig, useMuscleGroupMutations"
      pattern: "useEffectiveMuscleGroupConfig|useMuscleGroupMutations"
    - from: "src/ui/components/settings/MuscleGroupEditor.tsx"
      to: "@dnd-kit/core"
      via: "DndContext"
      pattern: "DndContext"
---

<objective>
Build the Settings UI for managing custom muscle groups with drag-and-drop reordering.

Purpose: Enable users to create, edit, delete, and reorder muscle groups through an intuitive accordion interface with drag handles, inline editing, and a muscle picker modal.

Output: MuscleGroupEditor and supporting components in src/ui/components/settings/, integrated into Settings.tsx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-custom-grouping/09-CONTEXT.md
@.planning/phases/09-custom-grouping/09-RESEARCH.md
@.planning/phases/09-custom-grouping/09-01-SUMMARY.md
@src/ui/pages/Settings.tsx
@src/core/taxonomy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and create base components</name>
  <files>package.json, src/ui/components/settings/ConfirmationDialog.tsx, src/ui/components/settings/SortableMuscleItem.tsx</files>
  <action>
1. Install dnd-kit packages:
   `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

2. Create `src/ui/components/settings/ConfirmationDialog.tsx`:
   - Props: isOpen, title, message, confirmText, cancelText, onConfirm, onCancel
   - Render null if not open
   - Fixed overlay with centered modal (bg-black/50)
   - Modal card with bg-primary-800, rounded-lg, p-6, max-w-sm
   - Title as h3, message as p
   - Button row with Cancel (text button) and Confirm (cyan bg)

3. Create `src/ui/components/settings/SortableMuscleItem.tsx`:
   - Props: muscle (ScientificMuscle), onRemove callback
   - Use useSortable from @dnd-kit/sortable with muscle as id
   - Apply CSS.Transform.toString(transform) for drag animation
   - Layout: flex row with GripVertical icon (drag handle), muscle name, X button
   - Drag handle: button with {...attributes} {...listeners}
   - Styling: bg-primary-800, rounded, p-2, gap-2
   - Opacity 0.5 when isDragging

Use Lucide icons: GripVertical, X
  </action>
  <verify>
`npm ls @dnd-kit/core` shows installed
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
dnd-kit installed, ConfirmationDialog and SortableMuscleItem components created with proper styling and drag support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MusclePickerModal and SortableGroupRow</name>
  <files>src/ui/components/settings/MusclePickerModal.tsx, src/ui/components/settings/SortableGroupRow.tsx</files>
  <action>
1. Create `src/ui/components/settings/MusclePickerModal.tsx`:
   - Props: isOpen, onClose, availableMuscles (ScientificMuscle[]), onSelect (muscle => void)
   - Render null if not open
   - Fixed overlay with centered modal
   - Header: "Add Muscle" + X close button
   - Scrollable list of available muscles as buttons
   - Each muscle button calls onSelect(muscle) then onClose
   - Empty state if no available muscles: "All muscles are assigned"
   - Group available muscles by UI_MUSCLE_GROUPS for easier scanning

2. Create `src/ui/components/settings/SortableGroupRow.tsx`:
   - Props: group (CustomMuscleGroup), onUpdate, onDelete, onAddMuscle, availableMuscles
   - Use useSortable from @dnd-kit/sortable with group.id
   - State: isExpanded (boolean), isEditing (boolean), editName (string)
   - Collapsed header row:
     - GripVertical drag handle
     - Group name (or input if editing)
     - Muscle count badge
     - ChevronRight icon (rotates when expanded)
     - Edit button (pencil icon) / Delete button (trash icon)
   - Expanded content (when isExpanded):
     - DndContext + SortableContext for muscles
     - Map group.muscles to SortableMuscleItem
     - "+ Add Muscle" button at bottom (opens picker)
     - Handle muscle drag end with arrayMove
   - Double-click on name or edit button enables inline editing
   - Blur or Enter saves name via onUpdate
   - Delete with confirmation if group has muscles

Use Lucide icons: GripVertical, ChevronRight, Pencil, Trash2, Plus
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Lint passes: `npm run lint`
  </verify>
  <done>
MusclePickerModal displays available muscles grouped by category. SortableGroupRow handles expand/collapse, inline rename, drag handle for group reordering, and nested sortable for muscle reordering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create MuscleGroupEditor and integrate into Settings</name>
  <files>src/ui/components/settings/MuscleGroupEditor.tsx, src/ui/pages/Settings.tsx</files>
  <action>
1. Create `src/ui/components/settings/MuscleGroupEditor.tsx`:
   - Props: profileId (string)
   - Use useEffectiveMuscleGroupConfig(profileId) for current config
   - Use useMuscleGroupMutations(profileId) for save/reset
   - Local state: config copy for optimistic updates, pickerOpen, pickerGroupId, confirmDialog state
   - DndContext + SortableContext for group reordering (vertical strategy)
   - Render sections:
     a. Header with "+ Add Group" button (disabled if groups.length >= 8, show "Max 8 groups" tooltip)
     b. "Ungrouped" section (fixed, not sortable) - show muscles, allow removing to hidden
     c. Custom groups in SortableContext - map to SortableGroupRow
     d. "Hidden" section (fixed, not sortable) - show muscles, allow restoring to ungrouped
     e. "Reset to Defaults" button at bottom with confirmation dialog
   - Handle group drag end: arrayMove groups, save immediately
   - When adding group: generate id with generateId(), name "New Group", empty muscles array
   - When deleting group: move its muscles to ungrouped, then remove group
   - When removing last muscle from group: prompt "Delete this group?"
   - When adding muscle to group that exists elsewhere: use moveMuscle helper
   - Auto-save after every change via saveConfig (debounce not needed - operations are discrete)

2. Update `src/ui/pages/Settings.tsx`:
   - Import MuscleGroupEditor from @ui/components/settings/MuscleGroupEditor
   - Add new section BEFORE "Exercise Mappings" section:
     ```tsx
     {/* Muscle Groups Section */}
     <section className="rounded-lg bg-primary-700 p-6">
       <h3 className="mb-4 text-lg font-semibold text-white">Muscle Groups</h3>
       <p className="mb-4 text-sm text-primary-300">
         Customize how muscles are organized in the muscle list.
       </p>
       <MuscleGroupEditor profileId={currentProfile.id} />
     </section>
     ```

Import generateId from @db/schema for new group IDs.
Import moveMuscle from @core/muscle-groups for safe muscle moves.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Lint passes: `npm run lint`
Dev server runs: `npm run dev` - visit /settings
  </verify>
  <done>
MuscleGroupEditor shows all groups with drag-and-drop, inline editing, muscle picker, and reset button. Settings page displays the new Muscle Groups section.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run lint` - No linting errors
3. `npm run dev` - Start dev server
4. Navigate to Settings page:
   - Muscle Groups section visible
   - Default groups shown (Push, Pull, Legs, Core)
   - Can expand groups to see muscles
   - Can add new group (up to 8)
   - Can rename group inline
   - Can delete group (muscles go to ungrouped)
   - Can drag groups to reorder
   - Can drag muscles within group to reorder
   - Can add muscle via picker
   - Can remove muscle with X
   - Reset to Defaults works with confirmation
5. Refresh page - changes persist
</verification>

<success_criteria>
- All 5 component files created in src/ui/components/settings/
- MuscleGroupEditor integrated into Settings.tsx
- Drag-and-drop works for both groups and muscles within groups
- Inline editing for group names
- Muscle picker shows only unassigned muscles
- Delete confirmation when group has muscles
- Reset to defaults with confirmation
- Changes auto-save and persist across page refresh
- Max 8 groups enforced with disabled button
</success_criteria>

<output>
After completion, create `.planning/phases/09-custom-grouping/09-02-SUMMARY.md`
</output>
