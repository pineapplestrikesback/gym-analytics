---
phase: 09-custom-grouping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - src/core/muscle-groups.ts
  - src/db/hooks/useMuscleGroups.ts
  - src/db/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Profile can store custom muscle group configuration"
    - "Default groups exist when profile has no customizations"
    - "Each muscle can be in exactly one location (group, ungrouped, or hidden)"
    - "Maximum 8 groups enforced at type level"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "CustomMuscleGroup and MuscleGroupConfig interfaces, Profile field"
      contains: "customMuscleGroups?: MuscleGroupConfig"
    - path: "src/core/muscle-groups.ts"
      provides: "Default config, validation helpers, MAX_GROUPS constant"
      exports: ["DEFAULT_MUSCLE_GROUP_CONFIG", "MAX_GROUPS", "validateMuscleGroupConfig", "moveMuscle"]
    - path: "src/db/hooks/useMuscleGroups.ts"
      provides: "Hook for reading effective config and mutations"
      exports: ["useEffectiveMuscleGroupConfig", "useMuscleGroupMutations"]
  key_links:
    - from: "src/db/hooks/useMuscleGroups.ts"
      to: "src/db/hooks/useProfiles.ts"
      via: "useProfile and useUpdateProfile"
      pattern: "useProfile|useUpdateProfile"
    - from: "src/db/hooks/useMuscleGroups.ts"
      to: "src/core/muscle-groups.ts"
      via: "DEFAULT_MUSCLE_GROUP_CONFIG import"
      pattern: "DEFAULT_MUSCLE_GROUP_CONFIG"
---

<objective>
Create database schema extension and data hooks for custom muscle groups.

Purpose: Establish the data layer that stores user's custom muscle grouping configuration per-profile, with sensible defaults and validation to enforce business rules (max 8 groups, no muscle overlap).

Output: Types in schema.ts, default config and helpers in muscle-groups.ts, TanStack Query hook in useMuscleGroups.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-custom-grouping/09-CONTEXT.md
@.planning/phases/09-custom-grouping/09-RESEARCH.md
@src/db/schema.ts
@src/core/taxonomy.ts
@src/db/hooks/useProfiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema types and default configuration</name>
  <files>src/db/schema.ts, src/core/muscle-groups.ts</files>
  <action>
1. In `src/db/schema.ts`, add new interfaces BEFORE the Profile interface:

```typescript
/**
 * User-defined muscle group for organizing the muscle list
 */
export interface CustomMuscleGroup {
  id: string;           // Unique identifier (for drag-drop keys)
  name: string;         // Display name (user-editable)
  muscles: ScientificMuscle[];  // Ordered list of muscles in this group
}

/**
 * Complete muscle grouping configuration for a profile
 */
export interface MuscleGroupConfig {
  groups: CustomMuscleGroup[];      // Ordered custom groups (max 8)
  ungrouped: ScientificMuscle[];    // Muscles shown at top (promoted)
  hidden: ScientificMuscle[];       // Muscles excluded from list/heatmap
}
```

2. Add optional field to Profile interface:
```typescript
customMuscleGroups?: MuscleGroupConfig;  // Optional, defaults to preset
```

3. Create new file `src/core/muscle-groups.ts` with:
   - MAX_GROUPS constant (8)
   - DEFAULT_MUSCLE_GROUP_CONFIG with exactly 4 groups: Push, Pull, Legs, Core
   - Push: Pec Sternal, Pec Clavicular, Anterior Deltoid, Lateral Deltoid, Triceps Lateral/Medial, Triceps Long Head
   - Pull: Lats, Upper/Middle/Lower Traps, Posterior Deltoid, Biceps, Brachialis, Erector Spinae, Forearm Flexors, Forearm Extensors
   - Legs: Vastus Group, Rectus Femoris, Glute Max, Glute Med, Hamstrings, Adductors, Gastrocnemius, Soleus
   - Core: Rectus Abdominis, Obliques, Hip Flexors
   - ungrouped: empty array
   - hidden: empty array
   - NOTE: Arms muscles are distributed into Push (triceps) and Pull (biceps, brachialis, forearms) - no separate Arms group needed

4. Add validation function `validateMuscleGroupConfig(config: MuscleGroupConfig): { valid: boolean; errors: string[] }`:
   - Check all 26 SCIENTIFIC_MUSCLES are accounted for exactly once
   - Check groups.length <= MAX_GROUPS
   - Return detailed errors if invalid

5. Add helper function `moveMuscle(config: MuscleGroupConfig, muscle: ScientificMuscle, toLocation: { type: 'group'; groupId: string } | { type: 'ungrouped' } | { type: 'hidden' }): MuscleGroupConfig`:
   - Remove muscle from all current locations first
   - Add to target location
   - Return new config (immutable update)

Import ScientificMuscle and SCIENTIFIC_MUSCLES from @core/taxonomy.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Run: `npm run lint` passes
  </verify>
  <done>
Schema types exist, DEFAULT_MUSCLE_GROUP_CONFIG has all 26 muscles distributed across exactly 4 groups (Push, Pull, Legs, Core), validation catches overlap and missing muscles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useMuscleGroups hook</name>
  <files>src/db/hooks/useMuscleGroups.ts, src/db/hooks/index.ts</files>
  <action>
Create `src/db/hooks/useMuscleGroups.ts` with TanStack Query patterns matching existing hooks:

1. `useEffectiveMuscleGroupConfig(profileId: string | null)`:
   - Return type: `{ config: MuscleGroupConfig, isLoading: boolean, isUsingDefault: boolean, error: Error | null }`

   - Handle null profileId case:
     ```typescript
     if (!profileId) {
       return {
         config: DEFAULT_MUSCLE_GROUP_CONFIG,
         isLoading: false,
         isUsingDefault: true,
         error: null
       };
     }
     ```

   - Uses useProfile(profileId) to get profile data
   - While profile loading: return `{ config: DEFAULT_MUSCLE_GROUP_CONFIG, isLoading: true, isUsingDefault: true, error: null }`
   - On profile load complete:
     - If profile.customMuscleGroups exists: return `{ config: profile.customMuscleGroups, isLoading: false, isUsingDefault: false, error }`
     - Else: return `{ config: DEFAULT_MUSCLE_GROUP_CONFIG, isLoading: false, isUsingDefault: true, error }`

2. `useMuscleGroupMutations(profileId: string | null)`:
   - Uses useProfile and useUpdateProfile internally
   - Provides `saveConfig(config: MuscleGroupConfig): Promise<void>` that:
     - Validates config with validateMuscleGroupConfig
     - Throws if invalid
     - Calls updateProfile with spread profile + customMuscleGroups
   - Provides `resetToDefaults(): Promise<void>` that sets customMuscleGroups to undefined
   - Returns { saveConfig, resetToDefaults, isSaving: boolean }

3. Export both hooks from index.ts

Use existing patterns from useProfiles.ts:
- useQuery/useMutation from @tanstack/react-query
- Error typing as Error | null
- isPending for loading states
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Lint passes: `npm run lint`
  </verify>
  <done>
useMuscleGroups hook exports useEffectiveMuscleGroupConfig (with isUsingDefault flag and proper null/loading handling) and useMuscleGroupMutations, following existing TanStack Query patterns.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run lint` - No linting errors
3. `npm run test` - Existing tests still pass
4. Verify in code:
   - Profile interface has optional customMuscleGroups field
   - DEFAULT_MUSCLE_GROUP_CONFIG includes all 26 muscles with no duplicates across 4 groups
   - MAX_GROUPS = 8
   - validateMuscleGroupConfig catches missing muscles and duplicates
   - useEffectiveMuscleGroupConfig returns isUsingDefault boolean
</verification>

<success_criteria>
- Schema extended with CustomMuscleGroup, MuscleGroupConfig, Profile.customMuscleGroups
- Default config distributes all 26 muscles across 4 groups (Push, Pull, Legs, Core)
- Validation ensures no overlap and all muscles accounted for
- Hook provides effective config (custom or default), isUsingDefault flag, and save mutations
- Hook handles null profileId and loading states correctly
- No breaking changes to existing code
</success_criteria>

<output>
After completion, create `.planning/phases/09-custom-grouping/09-01-SUMMARY.md`
</output>
