---
phase: 09-custom-grouping
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - src/ui/components/mobile/MobileMuscleList.tsx
  - src/ui/components/mobile/MobileHeatmap.tsx
autonomous: false

must_haves:
  truths:
    - "Muscle list uses custom groups instead of static UI_MUSCLE_GROUPS"
    - "Ungrouped muscles appear at top of list (not in accordion)"
    - "Hidden muscles do not appear in muscle list"
    - "Hidden muscles are grayed out on heatmap body diagram"
    - "Group order matches user's custom configuration"
    - "Muscle order within groups matches user's custom configuration"
  artifacts:
    - path: "src/ui/components/mobile/MobileMuscleList.tsx"
      provides: "Muscle list using custom groups"
      contains: "useEffectiveMuscleGroupConfig"
    - path: "src/ui/components/mobile/MobileHeatmap.tsx"
      provides: "Heatmap with hidden muscle handling"
      contains: "hidden"
  key_links:
    - from: "src/ui/components/mobile/MobileMuscleList.tsx"
      to: "src/db/hooks/useMuscleGroups.ts"
      via: "useEffectiveMuscleGroupConfig"
      pattern: "useEffectiveMuscleGroupConfig"
    - from: "src/ui/components/mobile/MobileHeatmap.tsx"
      to: "src/db/hooks/useMuscleGroups.ts"
      via: "useEffectiveMuscleGroupConfig"
      pattern: "useEffectiveMuscleGroupConfig"
---

<objective>
Integrate custom muscle groups into the mobile muscle list and heatmap displays.

Purpose: Make the custom groupings user configured in Settings actually affect what they see on the Dashboard - ungrouped muscles promoted to top, hidden muscles grayed out on heatmap and excluded from list.

Output: Updated MobileMuscleList.tsx and MobileHeatmap.tsx that read from custom group configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-custom-grouping/09-CONTEXT.md
@.planning/phases/09-custom-grouping/09-RESEARCH.md
@.planning/phases/09-custom-grouping/09-01-SUMMARY.md
@.planning/phases/09-custom-grouping/09-02-SUMMARY.md
@src/ui/components/mobile/MobileMuscleList.tsx
@src/ui/components/mobile/MobileHeatmap.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MobileMuscleList to use custom groups</name>
  <files>src/ui/components/mobile/MobileMuscleList.tsx</files>
  <action>
Refactor MobileMuscleList.tsx to use custom muscle group configuration:

1. Import useEffectiveMuscleGroupConfig from @db/hooks/useMuscleGroups

2. Replace static UI_MUSCLE_GROUPS iteration with custom config:
   - Call useEffectiveMuscleGroupConfig(profileId)
   - Destructure { config, isLoading: configLoading }
   - Combine isLoading states: `isLoading || configLoading`

3. Update rendering logic:
   a. First render `config.ungrouped` muscles as flat list at top (no accordion):
      ```tsx
      {config.ungrouped.length > 0 && (
        <div className="space-y-3 mb-4">
          {config.ungrouped.map((muscle) => {
            // Render muscle row (same as current inside groups)
          })}
        </div>
      )}
      ```

   b. Then render `config.groups` in order (replacing UI_MUSCLE_GROUPS.map):
      ```tsx
      {config.groups.map((group) => {
        const isExpanded = expandedGroups.has(group.id);
        return (
          <div key={group.id} ...>
            {/* Group header - use group.name */}
            {/* Group content - iterate group.muscles */}
          </div>
        );
      })}
      ```

   c. Do NOT render `config.hidden` muscles anywhere

4. Update expandedGroups initial state:
   - Change from `new Set([UI_MUSCLE_GROUPS[0].name])`
   - To `new Set(config.groups[0]?.id ? [config.groups[0].id] : [])`
   - Use useEffect to reset expanded state when config changes (or useMemo with config dependency)

5. Update toggleGroup to use group.id instead of group.name:
   ```tsx
   const toggleGroup = (groupId: string): void => {
     const newExpanded = new Set(expandedGroups);
     if (newExpanded.has(groupId)) {
       newExpanded.delete(groupId);
     } else {
       newExpanded.add(groupId);
     }
     setExpandedGroups(newExpanded);
   };
   ```

Remove unused UI_MUSCLE_GROUPS import if no longer needed.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Lint passes: `npm run lint`
  </verify>
  <done>
MobileMuscleList renders ungrouped muscles at top, then custom groups in order, excluding hidden muscles. Group expansion uses group.id for stability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MobileHeatmap to gray out hidden muscles</name>
  <files>src/ui/components/mobile/MobileHeatmap.tsx</files>
  <action>
Update MobileHeatmap.tsx to handle hidden muscles:

1. Import useEffectiveMuscleGroupConfig from @db/hooks/useMuscleGroups

2. Get config and create hiddenMuscles Set:
   ```tsx
   const { config } = useEffectiveMuscleGroupConfig(profileId);
   const hiddenMuscles = useMemo(
     () => new Set(config.hidden),
     [config.hidden]
   );
   ```

3. Find where muscle/region colors are computed (likely in the stats calculation or when mapping REGION_TO_MUSCLES).

4. When computing region color/stats, check if all muscles in that region are hidden:
   ```tsx
   // For each region being rendered
   const regionMuscles = REGION_TO_MUSCLES[regionKey];
   const visibleMuscles = regionMuscles.filter(m => !hiddenMuscles.has(m));

   if (visibleMuscles.length === 0) {
     // All muscles in this region are hidden - use gray color
     return 'rgb(55, 65, 81)'; // primary-700 equivalent
   }
   ```

5. Alternatively, if individual muscles are colored:
   ```tsx
   const muscleColor = hiddenMuscles.has(muscleName)
     ? 'rgb(55, 65, 81)' // Gray for hidden
     : getVolumeColor(percentage);
   ```

6. Hidden muscles should still be visible on the body (so user sees the full body shape) but grayed out to indicate they're not being tracked.

Preserve all existing functionality for non-hidden muscles.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Lint passes: `npm run lint`
  </verify>
  <done>
MobileHeatmap shows hidden muscles in gray color instead of volume-based color, visually indicating they are excluded from tracking.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete custom muscle grouping feature:
- Settings UI for creating, editing, reordering groups
- MobileMuscleList showing custom groups with ungrouped muscles at top
- MobileHeatmap graying out hidden muscles
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000 on mobile viewport (or Chrome DevTools mobile mode)

**Settings verification:**
3. Go to Settings page
4. Find "Muscle Groups" section
5. Verify default groups appear (Push, Pull, Legs, Core)
6. Try: Create a new group, name it "Priority"
7. Try: Add a muscle to Priority group (should move from its current group)
8. Try: Drag Priority group to the top
9. Try: Expand a group, drag muscles to reorder
10. Try: Delete a group (muscles should move to Ungrouped)
11. Try: Move a muscle to Hidden section

**Dashboard verification:**
12. Go to Dashboard (main page)
13. Swipe to Muscle List view
14. Verify: Ungrouped muscles appear at top (no accordion)
15. Verify: Groups appear in your custom order
16. Verify: Hidden muscles are NOT in the list
17. Swipe to Heatmap view
18. Verify: Hidden muscles are grayed out on the body diagram

**Persistence verification:**
19. Refresh the page
20. Verify: All custom groupings are preserved

**Reset verification:**
21. Go back to Settings > Muscle Groups
22. Click "Reset to Defaults"
23. Confirm the dialog
24. Verify: Groups reset to Push, Pull, Legs, Core
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run lint` - No linting errors
3. `npm run test` - Existing tests pass
4. Manual verification via checkpoint task
</verification>

<success_criteria>
- MobileMuscleList uses useEffectiveMuscleGroupConfig instead of static UI_MUSCLE_GROUPS
- Ungrouped muscles render as flat list at top of muscle list
- Hidden muscles excluded from muscle list entirely
- Hidden muscles appear gray on heatmap body diagram
- Group order and muscle order respect user configuration
- All existing functionality preserved for non-hidden muscles
- Human verification confirms end-to-end feature works
</success_criteria>

<output>
After completion, create `.planning/phases/09-custom-grouping/09-03-SUMMARY.md`
</output>
