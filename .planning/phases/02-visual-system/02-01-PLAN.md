---
phase: 02-visual-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/color-scale.ts
  - src/core/__tests__/color-scale.test.ts
  - src/index.css
autonomous: true

must_haves:
  truths:
    - 'getVolumeColor returns purple for 0% volume'
    - 'getVolumeColor returns green for 100% volume (goal achieved)'
    - 'getVolumeColor returns red only above 100% (warning/over-target)'
    - 'Color transitions are smooth across percentage ranges'
    - 'CSS design tokens define dark surface hierarchy'
  artifacts:
    - path: 'src/core/color-scale.ts'
      provides: 'Pure color utility functions for volume-to-color mapping'
      exports: ['getVolumeColor', 'getVolumeOpacity']
    - path: 'src/core/__tests__/color-scale.test.ts'
      provides: 'Unit tests for color scale functions'
      contains: 'describe.*color-scale'
    - path: 'src/index.css'
      provides: 'CSS design tokens for surfaces, text, and volume colors'
      contains: '--color-surface-base'
  key_links:
    - from: 'src/core/color-scale.ts'
      to: 'Oklab color space'
      via: 'oklch() CSS output'
      pattern: "oklch\\("
---

<objective>
Create centralized color scale utility and CSS design tokens for the visual system.

Purpose: Establish a single source of truth for volume-to-color mapping using perceptually uniform Oklab color space, replacing scattered inline color logic throughout the codebase. This foundation enables consistent visual language across heatmap, progress bars, and all volume-related UI.

Output: Pure color utility in src/core/ with unit tests, plus CSS design tokens for dark theme surfaces and text hierarchy.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-visual-system/02-CONTEXT.md
@.planning/phases/02-visual-system/02-RESEARCH.md

# Existing code to understand current color usage

@src/index.css
@src/core/taxonomy.ts
@src/ui/components/MuscleHeatmap.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create color scale utility with Oklab interpolation</name>
  <files>
    src/core/color-scale.ts
    src/core/__tests__/color-scale.test.ts
  </files>
  <action>
Create `src/core/color-scale.ts` with pure functions (NO React dependencies) following existing core/ patterns:

**Main function: `getVolumeColor(percentage: number): string`**

- Returns CSS oklch() string for direct use in SVG fill and CSS
- Implements gradient: Purple (0%) -> Blue (25%) -> Teal (50%) -> Green (75-100%) -> Yellow (110%) -> Red (150%)
- Use Oklab linear interpolation between stops for perceptually uniform transitions
- Clamp input to 0-150 range (150% = max warning)
- 0% returns a distinct cool gray (not the "no target" gray)

**Color stops in oklch (Lightness, Chroma, Hue):**

```
0%: oklch(0.45 0.12 290) - muted purple (cool, low volume)
25%: oklch(0.55 0.15 250) - blue
50%: oklch(0.60 0.14 200) - teal
75%: oklch(0.65 0.16 160) - yellow-green
100%: oklch(0.72 0.19 142) - green (goal achieved!)
110%: oklch(0.75 0.18 85) - yellow (slight over)
150%: oklch(0.55 0.22 29) - red (warning, caps here)
```

**Secondary function: `getVolumeOpacity(percentage: number): number`**

- Returns opacity value 0.4-1.0
- Lower volume = more transparent (0% = 0.4, 100%+ = 1.0)
- Smooth progression, not stepped

**Helper: `getNoTargetColor(): string`**

- Returns a distinct gray for "no target defined" state
- oklch(0.35 0.02 270) - slightly different from 0% to distinguish

**Implementation approach:**

1. Define color stops as array of {position, L, C, H} objects
2. Create `interpolateOklch()` helper for linear interpolation between two stops
3. Create `getColorAtPosition()` that finds surrounding stops and interpolates
4. Main function clamps input, calls getColorAtPosition, formats as oklch() string

**Create test file `src/core/__tests__/color-scale.test.ts`:**

- Test 0% returns purple-ish oklch (hue around 290)
- Test 100% returns green oklch (hue around 142)
- Test 150% returns red oklch (hue around 29)
- Test values between stops interpolate smoothly
- Test clamping: -10% clamps to 0%, 200% clamps to 150%
- Test opacity increases with percentage
- Test no-target color is distinct from 0% volume

Use existing test patterns from src/core/**tests**/ for structure.
</action>
<verify>
npm run test -- color-scale
All tests pass. Functions are exported and callable.
</verify>
<done>
color-scale.ts exports getVolumeColor, getVolumeOpacity, getNoTargetColor. All unit tests pass. Colors use oklch() format.
</done>
</task>

<task type="auto">
  <name>Task 2: Add CSS design tokens for dark theme</name>
  <files>src/index.css</files>
  <action>
Update `src/index.css` @theme block to add semantic design tokens while preserving existing colors.

**Add surface hierarchy (dark theme backgrounds):**

```css
--color-surface-base: oklch(0.13 0.01 270); /* Darkest - page background */
--color-surface-raised: oklch(0.16 0.01 270); /* Cards, panels */
--color-surface-overlay: oklch(0.2 0.01 270); /* Modals, pop-ups */
```

**Add text hierarchy:**

```css
--color-text-primary: oklch(0.95 0 0); /* Main text */
--color-text-secondary: oklch(0.75 0 0); /* Supporting text */
--color-text-muted: oklch(0.55 0 0); /* Disabled/dimmed */
```

**Add semantic status colors:**

```css
--color-status-success: oklch(0.72 0.19 142); /* Green - goal met */
--color-status-warning: oklch(0.75 0.18 85); /* Yellow - over target */
--color-status-danger: oklch(0.55 0.22 29); /* Red - significantly over */
```

**Keep existing colors intact:**

- primary-50 through primary-900 (zinc grays - still useful)
- accent-cyan, accent-orange, accent-red, accent-yellow, accent-blue

**Note:** Volume-specific colors are NOT defined in CSS - they come from the JS color-scale.ts function since they need dynamic percentage interpolation. CSS tokens are for static semantic colors only.

Format: Use oklch() for new tokens (perceptually uniform). Keep existing hex values as-is to avoid breaking existing Tailwind classes.
</action>
<verify>
npm run build
Build succeeds. New CSS variables are defined (inspect output CSS or check index.css directly).
</verify>
<done>
index.css has surface-base, surface-raised, surface-overlay tokens. Text hierarchy tokens defined. Status colors defined. Existing colors preserved. Build passes.
</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run test` - All tests pass including new color-scale tests
2. `npm run build` - Production build succeeds
3. Manual check: src/core/color-scale.ts exports three functions
4. Manual check: src/index.css has new @theme tokens
</verification>

<success_criteria>

- [ ] getVolumeColor(0) returns purple-ish oklch color
- [ ] getVolumeColor(100) returns green oklch color (VIS-01: green at target)
- [ ] getVolumeColor(150) returns red oklch color (VIS-01: red only for over-target)
- [ ] All color-scale unit tests pass
- [ ] CSS tokens define dark surface hierarchy (VIS-03)
- [ ] Build passes with no errors
      </success_criteria>

<output>
After completion, create `.planning/phases/02-visual-system/02-01-SUMMARY.md`
</output>
