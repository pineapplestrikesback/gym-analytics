---
phase: 04-front-back-toggle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/hooks/use-session-state.ts
  - src/ui/components/mobile/MobileHeatmap.tsx
autonomous: true

must_haves:
  truths:
    - 'User sees only front OR back view at a time, not split view'
    - 'Toggling views animates like rotating a body (3D flip)'
    - 'Toggle button is visually subtle and does not compete with body diagram'
    - 'View state persists across navigation within tab'
    - 'View state resets to front on page refresh or tab close'
  artifacts:
    - path: 'src/ui/hooks/use-session-state.ts'
      provides: 'Session-scoped state persistence hook'
      exports: ['useSessionState']
    - path: 'src/ui/components/mobile/MobileHeatmap.tsx'
      provides: '3D flip container with toggle'
      contains: 'rotateY'
  key_links:
    - from: 'src/ui/components/mobile/MobileHeatmap.tsx'
      to: 'src/ui/hooks/use-session-state.ts'
      via: 'useSessionState import'
      pattern: 'useSessionState.*front.*back'
---

<objective>
Implement front/back toggle with rotation-style animation for mobile heatmap

Purpose: Allow users to view front or back body separately with a 3D flip animation that feels like rotating the body, not switching modes. The toggle is visually quiet to keep focus on the body diagram.

Output: Mobile heatmap shows single view (front/back) with animated toggle and session-persisted state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-front-back-toggle/04-RESEARCH.md

# Current implementation to modify

@src/ui/components/mobile/MobileHeatmap.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSessionState hook and 3D flip structure</name>
  <files>
    src/ui/hooks/use-session-state.ts
    src/ui/components/mobile/MobileHeatmap.tsx
  </files>
  <action>
1. Create `src/ui/hooks/use-session-state.ts`:
   - Generic hook `useSessionState<T>(key: string, defaultValue: T): [T, (value: T) => void]`
   - Initialize from sessionStorage on mount (with SSR guard)
   - Wrap setState to also persist to sessionStorage
   - Handle JSON parse/stringify with try/catch for robustness
   - Use useCallback for stable setter reference

2. In MobileHeatmap.tsx, replace split view with 3D flip container:
   - Import useSessionState from @ui/hooks/use-session-state
   - Add state: `const [view, setView] = useSessionState<'front' | 'back'>('scientificmuscle_heatmap_view', 'front')`
   - Replace the current split layout (two half-width divs with center divider) with:
     - Perspective container (1000px perspective)
     - Rotating card div with transformStyle: preserve-3d
     - Front face: MobileBodyHighlighter type="anterior" with backfaceVisibility: hidden
     - Back face: Absolutely positioned, pre-rotated 180deg, backfaceVisibility: hidden, MobileBodyHighlighter type="posterior"
   - Apply rotateY(0deg) for 'front', rotateY(180deg) for 'back'
   - Transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1)
   - Add -webkit-backface-visibility for Safari compatibility

Key constraints from RESEARCH.md:

- Perspective on parent container, NOT on rotating element
- backfaceVisibility: hidden on BOTH faces
- Back face pre-rotated 180deg so it shows correctly when card flips
  </action>
  <verify> - `npm run build` passes with no TypeScript errors - Open mobile view in browser DevTools (iPhone 12 viewport) - Confirm only ONE body view visible at a time (not split) - Manually test: Toggle view in React DevTools by calling setView
  </verify>
  <done>
  Mobile heatmap shows single body view (front by default) with 3D flip structure ready for toggle control
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add subtle toggle button with animation polish</name>
  <files>
    src/ui/components/mobile/MobileHeatmap.tsx
  </files>
  <action>
1. Add toggle button below the body diagram:
   - Position: absolute, bottom-2, left-1/2, -translate-x-1/2
   - Minimum touch target: 44x44px (min-w-[44px] min-h-[44px])
   - Visual style (SUBTLE - TOGGLE-02):
     - text-xs text-primary-400 (low contrast text)
     - bg-primary-800/40 backdrop-blur-sm (semi-transparent background)
     - border border-primary-700/20 (very subtle border)
     - rounded-full (pill shape)
     - px-3 py-1.5 for padding
   - Active state: active:bg-primary-700/50
   - onClick: toggle view between 'front' and 'back'
   - aria-label for accessibility: "Show {opposite} view"

2. Add inline rotate icon SVG (consistent with codebase pattern):
   - Simple rotate arrows icon (from RESEARCH.md)
   - Size: w-3.5 h-3.5
   - Display icon + text label ("Front" or "Back" showing current opposite)

3. Animation polish:
   - Ensure animation feels smooth (0.5s is default, adjust if sluggish)
   - Add transition-colors duration-150 to button for hover/active feedback

4. Verify touch target accessibility:
   - Button must be at least 44x44px hit area even if visual appearance is smaller
     </action>
     <verify>
   - `npm run build` passes
   - Open http://localhost:3000 on mobile viewport (DevTools iPhone 12)
   - Toggle button visible below body diagram
   - Button is subtle (low contrast, doesn't dominate)
   - Tapping button animates body flip (rotation effect)
   - State persists: navigate away and back, view remains same
   - Page refresh: view resets to 'front'
     </verify>
     <done>
   - TOGGLE-01: Toggle animates like rotation (3D flip on Y-axis)
   - TOGGLE-02: Toggle is visually quiet (subtle styling)
   - TOGGLE-03: State persists across navigation (sessionStorage)
   - Button has 44px minimum touch target for accessibility
     </done>
     </task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` - No TypeScript errors
2. `npm run lint` - No linting violations
3. Manual testing on mobile viewport:
   - Default view is front (TOGGLE-03 partial)
   - Toggle button is visible but subtle (TOGGLE-02)
   - Tapping toggle animates body rotation (TOGGLE-01)
   - Navigate to another page and back - view persists (TOGGLE-03)
   - Refresh page - view resets to front (TOGGLE-03)
</verification>

<success_criteria>

- TOGGLE-01 satisfied: 3D rotateY animation creates rotation effect
- TOGGLE-02 satisfied: Button uses low-contrast colors, small size, pill shape
- TOGGLE-03 satisfied: sessionStorage persists view within tab session
- No regressions: Loading, error, and no-data states still work
- Accessibility: 44px touch target, proper aria-label
  </success_criteria>

<output>
After completion, create `.planning/phases/04-front-back-toggle/04-01-SUMMARY.md`
</output>
