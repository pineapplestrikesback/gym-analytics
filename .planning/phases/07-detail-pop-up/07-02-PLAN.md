---
phase: 07-detail-pop-up
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/ui/components/mobile/MobileHeatmap.tsx
  - src/ui/components/mobile/MuscleDetailModal.tsx
autonomous: false

must_haves:
  truths:
    - "Tapping a body region opens the detail modal showing muscles for that region"
    - "Selected region is highlighted with stroke/outline on the body diagram"
    - "Highlight persists while modal is open"
    - "Closing modal clears the highlight"
    - "Flipping body view (front/back toggle) auto-closes the modal"
    - "Modal displays correct muscles for the tapped region"
  artifacts:
    - path: "src/ui/components/mobile/MobileHeatmap.tsx"
      provides: "Integration with MuscleDetailModal and SVG highlighting"
      contains: "MuscleDetailModal"
    - path: "src/ui/components/mobile/MuscleDetailModal.tsx"
      provides: "Complete modal with highlighting coordination"
  key_links:
    - from: "MobileHeatmap"
      to: "MuscleDetailModal"
      via: "import and render with region prop"
      pattern: "import.*MuscleDetailModal.*from.*MuscleDetailModal"
    - from: "MobileHeatmap selectedRegion state"
      to: "MuscleDetailModal isOpen prop"
      via: "conditional rendering based on state"
      pattern: "isOpen=\\{.*selectedRegion"
    - from: "MobileHeatmap scoped style"
      to: "SVG polygon stroke"
      via: "CSS selector targeting selected region"
      pattern: "\\.rbh polygon.*stroke"
---

<objective>
Integrate MuscleDetailModal into MobileHeatmap with state management, SVG region highlighting, and auto-close on view flip. Enables users to tap body regions and see detailed muscle information in a dismissible overlay.

Purpose: Completes the detail pop-up feature by wiring the modal component to the existing heatmap, implementing highlighting visualization, and handling view transitions.

Output: Fully functional detail pop-up system ready for user testing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-detail-pop-up/07-CONTEXT.md
@.planning/phases/07-detail-pop-up/07-RESEARCH.md

# Plan 01 output
@.planning/phases/07-detail-pop-up/07-01-SUMMARY.md

# Integration targets
@src/ui/components/mobile/MobileHeatmap.tsx
@src/ui/components/mobile/MuscleDetailModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate modal into MobileHeatmap with state management</name>
  <files>src/ui/components/mobile/MobileHeatmap.tsx</files>
  <action>
Modify MobileHeatmap.tsx to integrate the MuscleDetailModal:

**1. Import modal component:**
```typescript
import { MuscleDetailModal } from './MuscleDetailModal';
```

**2. Modal state management:**
The component already has `selectedRegion` state (line 125). This will drive both the modal AND the highlight.

Modal is open when selectedRegion is not null. Modal closing sets selectedRegion to null.

**3. Add modal render below existing JSX:**
After the toggle button div (currently line 276), before closing the outer container div, add:

```typescript
{/* Muscle Detail Modal */}
<MuscleDetailModal
  isOpen={selectedRegion !== null}
  onClose={() => setSelectedRegion(null)}
  region={selectedRegion}
  muscles={selectedRegion ? REGION_TO_MUSCLES[selectedRegion] : []}
  profileId={profileId}
  daysBack={daysBack}
/>
```

**4. Auto-close modal on view flip (CONTEXT.md requirement):**
Modify the `toggleView` function (line 194) to clear selectedRegion:

```typescript
const toggleView = (): void => {
  setSelectedRegion(null); // Clear selection when flipping
  setView(view === 'front' ? 'back' : 'front');
};
```

**5. Export BodyRegion type:**
At the top of the file, after the type definition (line 27-41), add:
```typescript
export type { BodyRegion };
```

This allows MuscleDetailModal to import the type cleanly.

**Why this works:**
- selectedRegion state is already managed by MobileBodyHighlighter's click handler
- Bilateral highlighting (HEAT-BILATERAL-01) already implemented - tapping one side highlights both
- Persistence (HEAT-PERSIST-01) already works - selection stays until cleared
- We're just adding the modal as an additional consumer of the same state
  </action>
  <verify>
Check modal integration:
```bash
grep -n "MuscleDetailModal" src/ui/components/mobile/MobileHeatmap.tsx
```

Verify toggleView clears selection:
```bash
grep -A 3 "const toggleView" src/ui/components/mobile/MobileHeatmap.tsx
```

Verify BodyRegion export:
```bash
grep "export type.*BodyRegion" src/ui/components/mobile/MobileHeatmap.tsx
```

Run TypeScript check:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- MuscleDetailModal imported and rendered in MobileHeatmap
- Modal isOpen tied to selectedRegion !== null
- Modal onClose clears selectedRegion
- toggleView function clears selectedRegion before flipping
- BodyRegion type exported for use in MuscleDetailModal
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SVG region highlighting when modal open</name>
  <files>src/ui/components/mobile/MobileHeatmap.tsx</files>
  <action>
Add visual highlighting for the selected region in the MobileBodyHighlighter component:

**Location:** Inside the `MobileBodyHighlighter` function component (starts line 283), modify the scoped `<style>` block (currently line 386).

**Current style block** highlights selected muscles with amber color (frequency 6 - line 105). This gives the "selected state" color but is subtle.

**Add explicit stroke highlighting** for better visibility when modal is open:

After the existing hover/active styles (line 407), add:

```css
/* Selected region highlighting - white stroke when modal open */
[data-mobile-heatmap="${scopeId}"] .rbh polygon[data-frequency="6"] {
  stroke: white;
  stroke-width: 2px;
  stroke-opacity: 0.8;
}
```

**Why this works:**
- Selected regions already use frequency 6 (line 307)
- react-body-highlighter exposes data-frequency attribute on polygons
- This adds a prominent white stroke overlay to the amber fill
- Stroke appears when selectedRegion is set (which happens when modal opens)
- Stroke disappears when selectedRegion is cleared (when modal closes)

**Alternative approach if data-frequency doesn't work:**
If the library doesn't expose data-frequency, target by region name instead:

```typescript
// In the style block, generate dynamic selectors for selected region
${selectedRegion ? `
  /* Highlight selected region: ${selectedRegion} */
  ${REGION_TO_LIBRARY_MUSCLES[selectedRegion][viewKey].map(muscle => `
    [data-mobile-heatmap="${scopeId}"] .rbh polygon#${muscle},
    [data-mobile-heatmap="${scopeId}"] .rbh polygon.${muscle}
  `).join(',\n')} {
    stroke: white;
    stroke-width: 2px;
    stroke-opacity: 0.8;
  }
` : ''}
```

Use the data-frequency approach first. Only switch to the dynamic selector if needed.

**Styling notes (from CONTEXT.md):**
- Use white or accent color for stroke (chose white for high contrast)
- Constant highlight style (no variation based on volume) ✓
- Highlight renders behind modal (z-index already correct - modal is z-50) ✓
  </action>
  <verify>
Check highlighting CSS added:
```bash
grep -A 4 "data-frequency=\"6\"" src/ui/components/mobile/MobileHeatmap.tsx
```

OR if using dynamic approach:
```bash
grep "selectedRegion.*stroke" src/ui/components/mobile/MobileHeatmap.tsx
```

Run TypeScript check:
```bash
npx tsc --noEmit
```

Run linter:
```bash
npm run lint
```
  </verify>
  <done>
- SVG polygon highlighting added to MobileBodyHighlighter scoped styles
- Selected region shows white stroke when selectedRegion state is set
- Highlighting automatically appears when modal opens
- Highlighting automatically clears when modal closes
- No compilation or lint errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete muscle detail modal system integrated into mobile heatmap:
- Task 1: Modal wired to selectedRegion state with auto-close on view flip
- Task 2: SVG highlighting shows white stroke on selected regions
  </what-built>
  <how-to-verify>
**Test the complete feature:**

1. **Start dev server:**
```bash
npm run dev
```

2. **Open mobile view:**
   - Navigate to http://localhost:3000
   - Open browser DevTools
   - Toggle device emulation (iPhone 12 or similar)
   - Ensure you have workout data (if not, import CSV or add via UI)

3. **Test modal opening:**
   - Tap any colored muscle region on the front body view
   - VERIFY: Modal appears centered on screen with muscle list
   - VERIFY: Modal shows muscles for that region (e.g., chest tap shows "Pectoralis Major (Sternal)" and "Pectoralis Major (Clavicular)")
   - VERIFY: Each muscle shows name, volume/goal ratio (e.g., "15/12"), progress bar

4. **Test SVG highlighting:**
   - With modal open, look at the body diagram behind it
   - VERIFY: Tapped region has visible white stroke/outline
   - VERIFY: For bilateral regions (shoulders, chest), both left and right sides are highlighted

5. **Test dismiss behaviors:**
   - Tap backdrop (dark area outside modal) - VERIFY: Modal closes, highlight disappears
   - Re-open modal, tap X button (top-right corner) - VERIFY: Modal closes
   - Re-open modal, press Escape key - VERIFY: Modal closes
   - Re-open modal, swipe down on modal content - VERIFY: Modal closes
   - VERIFY: After each dismiss, the white stroke disappears from body diagram

6. **Test view flip auto-close:**
   - Open modal by tapping a region
   - Tap the "Back" or "Front" toggle button at bottom
   - VERIFY: Modal closes automatically when body flips
   - VERIFY: Highlight clears when view changes

7. **Test edge cases:**
   - Tap different regions in sequence - VERIFY: Modal updates with correct muscles
   - Scroll within modal (if muscle list is long) - VERIFY: Scrolling works, doesn't trigger swipe-dismiss
   - Tap outside modal multiple times - VERIFY: No errors, behaves correctly

8. **Visual checks:**
   - VERIFY: Modal is centered and responsive to screen size
   - VERIFY: Progress bars use same color scale as heatmap (purple → green → orange/red)
   - VERIFY: Modal feels lightweight and dismissible (not blocking or heavy)
   - VERIFY: Text is readable against dark background
   - VERIFY: X button is easily tappable (44x44 touch target)

**Expected behavior:**
- ✓ Modal opens when tapping any body region
- ✓ Selected region shows white stroke outline
- ✓ Modal displays muscles with volume/goal data
- ✓ All 4 dismiss methods work (backdrop, X, Escape, swipe-down)
- ✓ Flipping body auto-closes modal
- ✓ No console errors
- ✓ Performance is smooth (no lag or jank)

**If issues found:**
Describe any problems with:
- Which browser/device
- Steps to reproduce
- Expected vs actual behavior
- Screenshots if visual issues
  </how-to-verify>
  <resume-signal>
Type "approved" if all verifications pass, or describe any issues found that need fixing.
  </resume-signal>
</task>

</tasks>

<verification>
After Task 1 and 2 (before checkpoint):

```bash
# Modal integration verified
grep "MuscleDetailModal" src/ui/components/mobile/MobileHeatmap.tsx

# Auto-close on flip verified
grep -A 2 "toggleView.*void" src/ui/components/mobile/MobileHeatmap.tsx | grep "setSelectedRegion"

# Highlighting CSS verified
grep "stroke.*white" src/ui/components/mobile/MobileHeatmap.tsx

# Compilation check
npx tsc --noEmit

# Lint check
npm run lint
```
</verification>

<success_criteria>
Plan complete when:

- [x] MuscleDetailModal integrated into MobileHeatmap
- [x] Modal opens when selectedRegion state is set
- [x] Modal closes when user dismisses via any method
- [x] toggleView function clears selectedRegion (auto-close on flip)
- [x] SVG regions show white stroke when selected
- [x] Highlighting appears/disappears with modal open/close
- [x] Human verification confirms all functionality works correctly
- [x] No TypeScript or ESLint errors
- [x] Requirements DETAIL-01, DETAIL-02, DETAIL-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-detail-pop-up/07-02-SUMMARY.md` documenting:
- Integration approach (selectedRegion state as single source of truth)
- Highlighting implementation (CSS targeting frequency 6)
- Auto-close behavior on view flip
- User testing results from checkpoint
- Any edge cases or issues discovered during verification
</output>
