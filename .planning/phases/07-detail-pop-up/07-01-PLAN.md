---
phase: 07-detail-pop-up
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/components/mobile/MuscleDetailModal.tsx
autonomous: true

must_haves:
  truths:
    - "Modal displays muscles for a tapped body region with name, volume/goal ratio, and progress bar"
    - "Modal can be dismissed by tapping outside the modal content"
    - "Modal can be dismissed by tapping X button"
    - "Modal can be dismissed by swiping down on modal content"
    - "Modal can be dismissed by pressing Escape key"
  artifacts:
    - path: "src/ui/components/mobile/MuscleDetailModal.tsx"
      provides: "Portal-based modal component with muscle detail list"
      min_lines: 150
      exports: ["MuscleDetailModal"]
  key_links:
    - from: "MuscleDetailModal component"
      to: "@core/color-scale"
      via: "getVolumeColor import"
      pattern: "import.*getVolumeColor.*@core/color-scale"
    - from: "MuscleDetailModal component"
      to: "@db/hooks/useVolumeStats"
      via: "useScientificMuscleVolume import"
      pattern: "import.*useScientificMuscleVolume.*@db/hooks"
---

<objective>
Create a modal component that displays individual muscle details for a tapped body region. The modal shows muscles within the region, each with name, current/goal sets, and progress bar. Implements all dismiss behaviors (tap outside, X button, swipe down, Escape key).

Purpose: Provides detailed muscle volume information when users tap body regions on the heatmap, supporting the requirement that users can inspect specific areas without navigating away from the visualization.

Output: Reusable modal component ready for integration with MobileHeatmap in Plan 02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-detail-pop-up/07-CONTEXT.md
@.planning/phases/07-detail-pop-up/07-RESEARCH.md

# Existing mobile components for pattern reference
@src/ui/components/mobile/MobileHeatmap.tsx
@src/ui/components/mobile/MobileMuscleList.tsx

# Existing modal pattern reference
@src/ui/components/exercise-mapping/AutoMatchReviewModal.tsx

# Data and styling dependencies
@src/core/color-scale.ts
@src/db/hooks/useVolumeStats.ts
@src/core/taxonomy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create modal component with muscle list layout</name>
  <files>src/ui/components/mobile/MuscleDetailModal.tsx</files>
  <action>
Create `MuscleDetailModal.tsx` in `src/ui/components/mobile/` with the following structure:

**Component signature:**
```typescript
interface MuscleDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  region: BodyRegion | null;
  muscles: ScientificMuscle[];
  profileId: string | null;
  daysBack?: number;
}

export function MuscleDetailModal({ isOpen, onClose, region, muscles, profileId, daysBack = 7 }: MuscleDetailModalProps): React.ReactElement | null
```

**Implementation requirements:**

1. **Portal rendering (RESEARCH Pattern 1):**
   - Use `createPortal` from 'react-dom' to render modal at document.body
   - Return null when `isOpen` is false
   - Don't create portal if region is null or muscles array is empty

2. **Body scroll locking (RESEARCH Pattern 1):**
   - useEffect that sets `document.body.style.overflow = 'hidden'` when modal opens
   - Cleanup returns overflow to default value
   - Only run effect when isOpen is true

3. **Data fetching:**
   - Import `useScientificMuscleVolume` from `@db/hooks/useVolumeStats`
   - Call hook to get stats
   - Use `useMemo` to create statsMap for O(1) muscle lookup
   - Filter stats to only muscles in the `muscles` prop array

4. **Layout structure:**
   - Fixed overlay backdrop: `fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4`
   - Centered modal card: `max-w-lg w-full bg-primary-800 rounded-lg overflow-hidden` (use primary-800 NOT surface-overlay - project uses primary colors, not surface tokens per existing MobileHeatmap pattern)
   - No header/title - muscle list starts immediately per CONTEXT.md
   - Scrollable muscle list with compact spacing (tighter than MobileMuscleList carousel)

5. **Muscle list items (adapt MobileMuscleList pattern):**
   - Each muscle: two-line layout
   - Line 1: muscle name (left, text-sm text-primary-200) + volume/goal ratio (right, text-xs text-primary-400 font-mono)
   - Line 2: progress bar (h-1, full width, rounded-full, bg-primary-900)
   - Progress bar fill: width clamped to 100%, backgroundColor from `getVolumeColor(percentage)`
   - Use `formatVolume` helper: `volume % 1 === 0 ? volume.toString() : volume.toFixed(1)`
   - Spacing between items: space-y-2 (tighter than carousel's space-y-3)

6. **Fade-in animation (existing AutoMatchReviewModal pattern):**
   - Backdrop has inline style: `style={{ animation: 'fadeIn 0.2s ease-out' }}`
   - Include inline `<style>` tag with @keyframes fadeIn (from opacity 0 to 1)

7. **TypeScript:**
   - Import BodyRegion type from MobileHeatmap (copy type definition into new file since not exported)
   - Import ScientificMuscle from `@core/taxonomy`
   - Explicit return type: `React.ReactElement | null`
   - No `any` types

**What NOT to do:**
- Don't add dismiss handlers yet (Task 2)
- Don't use react-body-highlighter in this component (highlighting happens in MobileHeatmap)
- Don't use surface-overlay or design tokens from VIS-03 (project uses primary-* colors directly per existing components)
- Don't add complex animations beyond the simple fadeIn (keep it lightweight per CONTEXT "should feel lightweight")
  </action>
  <verify>
Run TypeScript check to confirm no type errors:
```bash
npx tsc --noEmit
```

Verify component exports:
```bash
grep -n "export function MuscleDetailModal" src/ui/components/mobile/MuscleDetailModal.tsx
```

Verify portal usage:
```bash
grep -n "createPortal" src/ui/components/mobile/MuscleDetailModal.tsx
```
  </verify>
  <done>
- MuscleDetailModal.tsx exists with portal-based rendering
- Component accepts isOpen, onClose, region, muscles, profileId, daysBack props
- Modal displays filtered muscle list with name, volume/goal ratio, progress bar
- Body scroll locked when modal open
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add all dismiss behaviors</name>
  <files>src/ui/components/mobile/MuscleDetailModal.tsx</files>
  <action>
Add dismiss functionality to existing MuscleDetailModal component:

**1. Backdrop click dismiss (RESEARCH Pattern 1 + AutoMatchReviewModal pattern):**
```typescript
const handleBackdropClick = (e: React.MouseEvent<HTMLDivElement>): void => {
  if (e.target === e.currentTarget) {
    onClose();
  }
};
```
Apply to backdrop div: `onClick={handleBackdropClick}`

**2. X button (top-right corner):**
- Add button in absolute position: `absolute top-3 right-3 min-w-[44px] min-h-[44px]`
- Use subtle styling: `text-primary-400 hover:text-primary-200 transition-colors`
- Inline X icon SVG (lucide-react style):
  ```jsx
  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
  </svg>
  ```
- aria-label: "Close"
- onClick: `onClose()`

**3. Escape key dismiss (RESEARCH Pattern 5):**
```typescript
useEffect(() => {
  if (!isOpen) return;

  const handleEscape = (e: KeyboardEvent): void => {
    if (e.key === 'Escape') {
      onClose();
    }
  };

  window.addEventListener('keydown', handleEscape);
  return () => window.removeEventListener('keydown', handleEscape);
}, [isOpen, onClose]);
```

**4. Swipe-down dismiss (RESEARCH Pattern 2 - simplified):**
Implement vanilla touch events for downward swipe detection on the modal card (NOT the backdrop):

```typescript
const [touchStart, setTouchStart] = useState(0);

const handleTouchStart = (e: React.TouchEvent): void => {
  setTouchStart(e.touches[0].clientY);
};

const handleTouchEnd = (e: React.TouchEvent): void => {
  const touchEnd = e.changedTouches[0].clientY;
  const deltaY = touchEnd - touchStart;

  // Downward swipe threshold: 50px
  if (deltaY > 50) {
    onClose();
  }
};
```

Apply to modal card div (the inner content div, not backdrop):
```jsx
<div
  className="max-w-lg w-full bg-primary-800 rounded-lg overflow-hidden"
  onTouchStart={handleTouchStart}
  onTouchEnd={handleTouchEnd}
>
```

**Critical:** Do NOT add `{ passive: false }` or preventDefault() - this would block scrolling within the modal list. The simple touchStart/touchEnd pattern allows both swipe-to-dismiss AND content scrolling.

**Testing considerations:**
- Backdrop click should close modal
- X button should be easily tappable on mobile (44x44 touch target)
- Escape key should work on desktop browsers
- Swipe down on modal content should dismiss (but don't block vertical scrolling)
  </action>
  <verify>
Check all dismiss handlers present:
```bash
grep -E "(handleBackdropClick|handleEscape|handleTouchStart|Escape)" src/ui/components/mobile/MuscleDetailModal.tsx
```

Verify X button exists:
```bash
grep -n "aria-label=\"Close\"" src/ui/components/mobile/MuscleDetailModal.tsx
```

Run TypeScript check:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- Modal can be dismissed by clicking backdrop outside modal content
- X button in top-right corner dismisses modal
- Escape key dismisses modal (desktop support)
- Swipe down gesture on modal content dismisses modal
- All event handlers properly typed with TypeScript
- No compilation errors
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Component exists and compiles:**
```bash
ls -la src/ui/components/mobile/MuscleDetailModal.tsx
npx tsc --noEmit
```

2. **Portal rendering confirmed:**
```bash
grep "createPortal" src/ui/components/mobile/MuscleDetailModal.tsx
```

3. **All dismiss methods present:**
```bash
grep -E "(handleBackdropClick|handleEscape|handleTouchStart)" src/ui/components/mobile/MuscleDetailModal.tsx | wc -l
```
Should show at least 3 matches.

4. **Data integration verified:**
```bash
grep "useScientificMuscleVolume" src/ui/components/mobile/MuscleDetailModal.tsx
grep "getVolumeColor" src/ui/components/mobile/MuscleDetailModal.tsx
```

5. **Linting passes:**
```bash
npm run lint
```
</verification>

<success_criteria>
Plan complete when:

- [x] MuscleDetailModal.tsx component created in src/ui/components/mobile/
- [x] Component renders via React portal to document.body
- [x] Modal displays muscle list with name, volume/goal, progress bar for provided region
- [x] Body scroll locked when modal open
- [x] Backdrop click dismisses modal
- [x] X button dismisses modal
- [x] Escape key dismisses modal
- [x] Swipe down dismisses modal
- [x] TypeScript compiles without errors
- [x] ESLint passes without violations
- [x] Component ready for integration with MobileHeatmap in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/07-detail-pop-up/07-01-SUMMARY.md` documenting:
- Component structure and props interface
- Dismiss behavior implementations
- Data fetching approach (useScientificMuscleVolume + statsMap filtering)
- Layout decisions (compact spacing, two-line muscle items)
- Portal pattern usage
</output>
